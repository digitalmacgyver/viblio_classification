<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">   
 <meta>
  <!-- Stylesheets -->
  <link href="../web.css" type="text/css" rel="stylesheet"></link>
  <title>VLFeat - Documentation - C API</title>
   
  
  <!-- Scripts-->
  
 </meta>
 
 <!-- Body Start -->
 <body>
  <div id="header">
   <!-- Google CSE Search Box Begins -->
   <form action="http://www.vlfeat.org/search.html" method="get" id="cse-search-box" enctype="application/x-www-form-urlencoded">
    <div>
     <input type="hidden" name="cx" value="003215582122030917471:oq23albfeam"></input>
     <input type="hidden" name="cof" value="FORID:11"></input>
     <input type="hidden" name="ie" value="UTF-8"></input>
     <input type="text" name="q" size="31"></input>
     <input type="submit" name="sa" value="Search"></input>
    </div>
   </form>
   <script src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" xml:space="preserve" type="text/javascript"></script>
   <!-- Google CSE Search Box Ends -->
   <h1>VLFeat.org</h1>
  </div>
  <div id="headbanner">
   Documentation - C API
  </div>
  <div id="pagebody">
   <div id="sidebar"> <!-- Navigation Start -->
    <ul>
<li><a href="../index.html">Home</a>
</li>
<li><a href="../download.html">Download</a>
</li>
<li><a href="../doc.html">Documentation</a>
<ul>
<li><a href="../mdoc/mdoc.html">Matlab API</a>
</li>
<li><a href="index.html" class='active' >C API</a>
</li>
<li><a href="../man/man.html">Man pages</a>
</li>
</ul></li>
<li><a href="../overview/tut.html">Tutorials</a>
</li>
</ul>

   </div> <!-- sidebar -->
   <div id="content">
    
    <div class="doxygen">
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>dsift.c</h1><a href="dsift_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00007"></a>00007 <span class="comment">/* AUTORIGHTS</span>
<a name="l00008"></a>00008 <span class="comment"> Copyright (C) 2007-09 Andrea Vedaldi and Brian Fulkerson</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment"> This file is part of VLFeat, available in the terms of the GNU</span>
<a name="l00011"></a>00011 <span class="comment"> General Public License version 2.</span>
<a name="l00012"></a>00012 <span class="comment"> */</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="dsift_8h.html" title="Dense SIFT.">dsift.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="pgm_8h.html" title="Portable graymap format (PGM) parser.">pgm.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="mathop_8h.html" title="Math operations.">mathop.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="imopv_8h.html" title="Vectorized image operations.">imopv.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00020"></a>00020 
<a name="l00252"></a>00252 <span class="keywordtype">float</span> *
<a name="l00253"></a><a class="code" href="dsift_8c.html#9a99d480cf025b9f19cc3e3ee5b010c4">00253</a> <a class="code" href="dsift_8c.html#9a99d480cf025b9f19cc3e3ee5b010c4" title="Initialize new convolution kernel.">_vl_dsift_new_kernel</a> (<span class="keywordtype">int</span> binSize, <span class="keywordtype">int</span> numBins, <span class="keywordtype">int</span> binIndex, <span class="keywordtype">double</span> windowSize)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255   <span class="keywordtype">int</span> filtLen = 2 * binSize - 1 ;
<a name="l00256"></a>00256   <span class="keywordtype">float</span> * ker = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a> (<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * filtLen) ;
<a name="l00257"></a>00257   <span class="keywordtype">float</span> * kerIter = ker ;
<a name="l00258"></a>00258   <span class="keywordtype">float</span> delta = binSize * (binIndex - 0.5F * (numBins - 1)) ;
<a name="l00259"></a>00259   <span class="comment">/*</span>
<a name="l00260"></a>00260 <span class="comment">  float sigma = 0.5F * ((numBins - 1) * binSize + 1) ;</span>
<a name="l00261"></a>00261 <span class="comment">  float sigma = 0.5F * ((numBins) * binSize) ;</span>
<a name="l00262"></a>00262 <span class="comment">  */</span>
<a name="l00263"></a>00263   <span class="keywordtype">float</span> sigma = (float) binSize * (<span class="keywordtype">float</span>) windowSize ;
<a name="l00264"></a>00264   <span class="keywordtype">int</span> x ;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="keywordflow">for</span> (x = - binSize + 1 ; x &lt;= + binSize - 1 ; ++ x) {
<a name="l00267"></a>00267     <span class="keywordtype">float</span> z = (x - delta) / sigma ;
<a name="l00268"></a>00268     *kerIter++ = (1.0F - fabsf(x) / binSize) *
<a name="l00269"></a>00269       ((binIndex &gt;= 0) ? expf(- 0.5F * z*z) : 1.0F) ;
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271   <span class="keywordflow">return</span> ker ;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="keyword">static</span> <span class="keywordtype">float</span>
<a name="l00275"></a>00275 _vl_dsift_get_bin_window_mean
<a name="l00276"></a>00276 (<span class="keywordtype">int</span> binSize, <span class="keywordtype">int</span> numBins, <span class="keywordtype">int</span> binIndex, <span class="keywordtype">double</span> windowSize)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278   <span class="keywordtype">float</span> delta = binSize * (binIndex - 0.5F * (numBins - 1)) ;
<a name="l00279"></a>00279   <span class="comment">/*float sigma = 0.5F * ((numBins - 1) * binSize + 1) ;*/</span>
<a name="l00280"></a>00280   <span class="keywordtype">float</span> sigma = (float) binSize * (<span class="keywordtype">float</span>) windowSize ;
<a name="l00281"></a>00281   <span class="keywordtype">int</span> x ;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283   <span class="keywordtype">float</span> acc = 0.0 ;
<a name="l00284"></a>00284   <span class="keywordflow">for</span> (x = - binSize + 1 ; x &lt;= + binSize - 1 ; ++ x) {
<a name="l00285"></a>00285     <span class="keywordtype">float</span> z = (x - delta) / sigma ;
<a name="l00286"></a>00286     acc += ((binIndex &gt;= 0) ? expf(- 0.5F * z*z) : 1.0F) ;
<a name="l00287"></a>00287   }
<a name="l00288"></a>00288   <span class="keywordflow">return</span> acc /= (2 * binSize - 1) ;
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00299"></a>00299 VL_INLINE <span class="keywordtype">float</span>
<a name="l00300"></a><a class="code" href="dsift_8c.html#1a8319889b1833c105817eeb07f85675">00300</a> <a class="code" href="dsift_8c.html#1a8319889b1833c105817eeb07f85675" title="Normalize histogram.">_vl_dsift_normalize_histogram</a> (<span class="keywordtype">float</span> * begin, <span class="keywordtype">float</span> * end)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302   <span class="keywordtype">float</span> * iter ;
<a name="l00303"></a>00303   <span class="keywordtype">float</span>  norm = 0.0F ;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="keywordflow">for</span> (iter = begin ; iter &lt; end ; ++ iter) {
<a name="l00306"></a>00306     norm += (*iter) * (*iter) ;
<a name="l00307"></a>00307   }
<a name="l00308"></a>00308   norm = <a class="code" href="mathop_8h.html#fd17414c0bd6edce9280378201a24847" title="Fast sqrt approximation.">vl_fast_sqrt_f</a> (norm) + <a class="code" href="mathop_8h.html#8088f3da04d6bce27544adaa6da948ca" title="IEEE single precision epsilon (math constant).">VL_EPSILON_F</a> ;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="keywordflow">for</span> (iter = begin; iter &lt; end ; ++ iter) {
<a name="l00311"></a>00311     *iter /= norm ;
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313   <span class="keywordflow">return</span> norm ;
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00321"></a>00321 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00322"></a><a class="code" href="dsift_8c.html#85a2ddc18108b83931d3cb7c66e7b382">00322</a> <a class="code" href="dsift_8c.html#85a2ddc18108b83931d3cb7c66e7b382" title="Free internal buffers.">_vl_dsift_free_buffers</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>* <span class="keyword">self</span>)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324   <span class="keywordflow">if</span> (self-&gt;frames) {
<a name="l00325"></a>00325     <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(self-&gt;frames) ;
<a name="l00326"></a>00326     <span class="keyword">self</span>-&gt;frames = NULL ;
<a name="l00327"></a>00327   }
<a name="l00328"></a>00328   <span class="keywordflow">if</span> (self-&gt;descrs) {
<a name="l00329"></a>00329     <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(self-&gt;descrs) ;
<a name="l00330"></a>00330     <span class="keyword">self</span>-&gt;descrs = NULL ;
<a name="l00331"></a>00331   }
<a name="l00332"></a>00332   <span class="keywordflow">if</span> (self-&gt;grads) {
<a name="l00333"></a>00333     <span class="keywordtype">int</span> t ;
<a name="l00334"></a>00334     <span class="keywordflow">for</span> (t = 0 ; t &lt; <span class="keyword">self</span>-&gt;numGradAlloc ; ++t)
<a name="l00335"></a>00335       <span class="keywordflow">if</span> (self-&gt;grads[t]) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(self-&gt;grads[t]) ;
<a name="l00336"></a>00336     <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(self-&gt;grads) ;
<a name="l00337"></a>00337     <span class="keyword">self</span>-&gt;grads = NULL ;
<a name="l00338"></a>00338   }
<a name="l00339"></a>00339   <span class="keyword">self</span>-&gt;numFrameAlloc = 0 ;
<a name="l00340"></a>00340   <span class="keyword">self</span>-&gt;numBinAlloc = 0 ;
<a name="l00341"></a>00341   <span class="keyword">self</span>-&gt;numGradAlloc = 0 ;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00348"></a>00348 VL_EXPORT <span class="keywordtype">void</span>
<a name="l00349"></a><a class="code" href="dsift_8h.html#dd71202b9bea63e4ef0e7e6450d28469">00349</a> <a class="code" href="dsift_8c.html#dd71202b9bea63e4ef0e7e6450d28469" title="Updates internal buffers to current geometry.">_vl_dsift_update_buffers</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> * <span class="keyword">self</span>)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351   <span class="keywordtype">int</span> x1 = <span class="keyword">self</span>-&gt;boundMinX ;
<a name="l00352"></a>00352   <span class="keywordtype">int</span> x2 = <span class="keyword">self</span>-&gt;boundMaxX ;
<a name="l00353"></a>00353   <span class="keywordtype">int</span> y1 = <span class="keyword">self</span>-&gt;boundMinY ;
<a name="l00354"></a>00354   <span class="keywordtype">int</span> y2 = <span class="keyword">self</span>-&gt;boundMaxY ;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="keywordtype">int</span> rangeX = x2 - x1 - (<span class="keyword">self</span>-&gt;geom.numBinX - 1) * self-&gt;geom.binSizeX ;
<a name="l00357"></a>00357   <span class="keywordtype">int</span> rangeY = y2 - y1 - (self-&gt;geom.numBinY - 1) * <span class="keyword">self</span>-&gt;geom.binSizeY ;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <span class="keywordtype">int</span> numFramesX = (rangeX &gt;= 0) ? rangeX / self-&gt;stepX + 1 : 0 ;
<a name="l00360"></a>00360   <span class="keywordtype">int</span> numFramesY = (rangeY &gt;= 0) ? rangeY / <span class="keyword">self</span>-&gt;stepY + 1 : 0 ;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="keyword">self</span>-&gt;numFrames = numFramesX * numFramesY ;
<a name="l00363"></a>00363   <span class="keyword">self</span>-&gt;descrSize = <span class="keyword">self</span>-&gt;geom.numBinT *
<a name="l00364"></a>00364                     <span class="keyword">self</span>-&gt;geom.numBinX *
<a name="l00365"></a>00365                     <span class="keyword">self</span>-&gt;geom.numBinY ;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00376"></a>00376 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00377"></a><a class="code" href="dsift_8c.html#8b3119bdf4dd078826d1fa70231184fe">00377</a> <a class="code" href="dsift_8c.html#8b3119bdf4dd078826d1fa70231184fe" title="Allocate internal buffers.">_vl_dsift_alloc_buffers</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>* <span class="keyword">self</span>)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379   <a class="code" href="dsift_8c.html#dd71202b9bea63e4ef0e7e6450d28469" title="Updates internal buffers to current geometry.">_vl_dsift_update_buffers</a> (<span class="keyword">self</span>) ;
<a name="l00380"></a>00380   {
<a name="l00381"></a>00381     <span class="keywordtype">int</span> numFrameAlloc = <a class="code" href="dsift_8h.html#3b5fabb1496fc91a70669d4201f47a5b" title="Get number of keypoints.">vl_dsift_get_keypoint_num</a> (<span class="keyword">self</span>) ;
<a name="l00382"></a>00382     <span class="keywordtype">int</span> numBinAlloc   = <a class="code" href="dsift_8h.html#eade8b18c21954f00d76f5dcb12b9bfe" title="Get descriptor size.">vl_dsift_get_descriptor_size</a> (<span class="keyword">self</span>) ;
<a name="l00383"></a>00383     <span class="keywordtype">int</span> numGradAlloc  = <span class="keyword">self</span>-&gt;geom.numBinT ;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="comment">/* see if we need to update the buffers */</span>
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (numBinAlloc != self-&gt;numBinAlloc ||
<a name="l00387"></a>00387         numGradAlloc != self-&gt;numGradAlloc ||
<a name="l00388"></a>00388         numFrameAlloc != self-&gt;numFrameAlloc) {
<a name="l00389"></a>00389 
<a name="l00390"></a>00390       <span class="keywordtype">int</span> t ;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392       <a class="code" href="dsift_8c.html#85a2ddc18108b83931d3cb7c66e7b382" title="Free internal buffers.">_vl_dsift_free_buffers</a>(<span class="keyword">self</span>) ;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394       <span class="keyword">self</span>-&gt;frames = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structVlDsiftKeypoint__.html" title="Dense SIFT keypoint.">VlDsiftKeypoint</a>) * numFrameAlloc) ;
<a name="l00395"></a>00395       <span class="keyword">self</span>-&gt;descrs = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * numBinAlloc * numFrameAlloc) ;
<a name="l00396"></a>00396       <span class="keyword">self</span>-&gt;grads  = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>*) * numGradAlloc) ;
<a name="l00397"></a>00397       <span class="keywordflow">for</span> (t = 0 ; t &lt; numGradAlloc ; ++t) {
<a name="l00398"></a>00398         <span class="keyword">self</span>-&gt;grads[t] =
<a name="l00399"></a>00399           <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * self-&gt;imWidth * self-&gt;imHeight) ;
<a name="l00400"></a>00400       }
<a name="l00401"></a>00401       <span class="keyword">self</span>-&gt;numBinAlloc = numBinAlloc ;
<a name="l00402"></a>00402       <span class="keyword">self</span>-&gt;numGradAlloc = numGradAlloc ;
<a name="l00403"></a>00403       <span class="keyword">self</span>-&gt;numFrameAlloc = numFrameAlloc ;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00417"></a>00417 VL_EXPORT <a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> *
<a name="l00418"></a><a class="code" href="dsift_8h.html#7cf3c57331ccafb453b37b0c5736b945">00418</a> <a class="code" href="dsift_8c.html#5dc43589ca865d698cf09c60b2e19259" title="Create a new DSIFT filter.">vl_dsift_new</a> (<span class="keywordtype">int</span> imWidth, <span class="keywordtype">int</span> imHeight)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420   <a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> * <span class="keyword">self</span> = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a> (<span class="keyword">sizeof</span>(<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>)) ;
<a name="l00421"></a>00421   <span class="keyword">self</span>-&gt;imWidth  = imWidth ;
<a name="l00422"></a>00422   <span class="keyword">self</span>-&gt;imHeight = imHeight ;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="keyword">self</span>-&gt;stepX = 5 ;
<a name="l00425"></a>00425   <span class="keyword">self</span>-&gt;stepY = 5 ;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   <span class="keyword">self</span>-&gt;boundMinX = 0 ;
<a name="l00428"></a>00428   <span class="keyword">self</span>-&gt;boundMinY = 0 ;
<a name="l00429"></a>00429   <span class="keyword">self</span>-&gt;boundMaxX = imWidth - 1 ;
<a name="l00430"></a>00430   <span class="keyword">self</span>-&gt;boundMaxY = imHeight - 1 ;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432   <span class="keyword">self</span>-&gt;geom.numBinX = 4 ;
<a name="l00433"></a>00433   <span class="keyword">self</span>-&gt;geom.numBinY = 4 ;
<a name="l00434"></a>00434   <span class="keyword">self</span>-&gt;geom.numBinT = 8 ;
<a name="l00435"></a>00435   <span class="keyword">self</span>-&gt;geom.binSizeX = 5 ;
<a name="l00436"></a>00436   <span class="keyword">self</span>-&gt;geom.binSizeY = 5 ;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="keyword">self</span>-&gt;useFlatWindow = <a class="code" href="host_8h.html#bce143a5a9b51d987a74f2ad30046520" title="false (0) constant">VL_FALSE</a> ;
<a name="l00439"></a>00439   <span class="keyword">self</span>-&gt;windowSize = 2.0 ;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   <span class="keyword">self</span>-&gt;convTmp1 = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * self-&gt;imWidth * self-&gt;imHeight) ;
<a name="l00442"></a>00442   <span class="keyword">self</span>-&gt;convTmp2 = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * self-&gt;imWidth * self-&gt;imHeight) ;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444   <span class="keyword">self</span>-&gt;numBinAlloc = 0 ;
<a name="l00445"></a>00445   <span class="keyword">self</span>-&gt;numFrameAlloc = 0 ;
<a name="l00446"></a>00446   <span class="keyword">self</span>-&gt;numGradAlloc = 0 ;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448   <span class="keyword">self</span>-&gt;descrSize = 0 ;
<a name="l00449"></a>00449   <span class="keyword">self</span>-&gt;numFrames = 0 ;
<a name="l00450"></a>00450   <span class="keyword">self</span>-&gt;grads = NULL ;
<a name="l00451"></a>00451   <span class="keyword">self</span>-&gt;frames = NULL ;
<a name="l00452"></a>00452   <span class="keyword">self</span>-&gt;descrs = NULL ;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454   <a class="code" href="dsift_8c.html#dd71202b9bea63e4ef0e7e6450d28469" title="Updates internal buffers to current geometry.">_vl_dsift_update_buffers</a>(<span class="keyword">self</span>) ;
<a name="l00455"></a>00455   <span class="keywordflow">return</span> self ;
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00471"></a>00471 VL_EXPORT <a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> *
<a name="l00472"></a><a class="code" href="dsift_8h.html#8709d5f69c90b0ddd0a5b9151e075369">00472</a> <a class="code" href="dsift_8c.html#ad78f3b3661c1cd199839fb86c0838f3" title="Create a new DSIFT filter (basic interface).">vl_dsift_new_basic</a> (<span class="keywordtype">int</span> imWidth, <span class="keywordtype">int</span> imHeight, <span class="keywordtype">int</span> step, <span class="keywordtype">int</span> binSize)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474   <a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>* <span class="keyword">self</span> = <a class="code" href="dsift_8c.html#5dc43589ca865d698cf09c60b2e19259" title="Create a new DSIFT filter.">vl_dsift_new</a>(imWidth, imHeight) ;
<a name="l00475"></a>00475   <a class="code" href="structVlDsiftDescriptorGeometry__.html" title="Dense SIFT descriptor geometry.">VlDsiftDescriptorGeometry</a> geom = *<a class="code" href="dsift_8h.html#55eb4068cd76b03c3bb120a895b7ed13" title="Get SIFT descriptor geometry.">vl_dsift_get_geometry</a>(<span class="keyword">self</span>) ;
<a name="l00476"></a>00476   geom.<a class="code" href="structVlDsiftDescriptorGeometry__.html#2f7cebbca23740b47fd2a61e89a08316">binSizeX</a> = binSize ;
<a name="l00477"></a>00477   geom.<a class="code" href="structVlDsiftDescriptorGeometry__.html#7aa1b8189daa7c1f0d78f4b2fd6fec7a">binSizeY</a> = binSize ;
<a name="l00478"></a>00478   <a class="code" href="dsift_8h.html#930f20c25eab08d9490830b0a358ff2b" title="Set SIFT descriptor geometry.">vl_dsift_set_geometry</a>(<span class="keyword">self</span>, &amp;geom) ;
<a name="l00479"></a>00479   <a class="code" href="dsift_8h.html#42ae6bf77a9b737fd1e45ad5c43263dd" title="Set steps.">vl_dsift_set_steps</a>(<span class="keyword">self</span>, step, step) ;
<a name="l00480"></a>00480   <span class="keywordflow">return</span> self ;
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00488"></a>00488 VL_EXPORT <span class="keywordtype">void</span>
<a name="l00489"></a><a class="code" href="dsift_8h.html#513d16efd29e795f6affb1dc55344b35">00489</a> <a class="code" href="dsift_8c.html#513d16efd29e795f6affb1dc55344b35" title="Delete DSIFT filter.">vl_dsift_delete</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> * <span class="keyword">self</span>)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491   <a class="code" href="dsift_8c.html#85a2ddc18108b83931d3cb7c66e7b382" title="Free internal buffers.">_vl_dsift_free_buffers</a> (<span class="keyword">self</span>) ;
<a name="l00492"></a>00492   <span class="keywordflow">if</span> (self-&gt;convTmp2) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a> (self-&gt;convTmp2) ;
<a name="l00493"></a>00493   <span class="keywordflow">if</span> (self-&gt;convTmp1) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a> (self-&gt;convTmp1) ;
<a name="l00494"></a>00494   <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a> (<span class="keyword">self</span>) ;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 
<a name="l00503"></a>00503 VL_INLINE <span class="keywordtype">void</span>
<a name="l00504"></a><a class="code" href="dsift_8c.html#454f20230291e23285448813b230a0eb">00504</a> <a class="code" href="dsift_8c.html#454f20230291e23285448813b230a0eb" title="Process with Gaussian window.">_vl_dsift_with_gaussian_window</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a> * <span class="keyword">self</span>)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506   <span class="keywordtype">int</span> binx, biny, bint ;
<a name="l00507"></a>00507   <span class="keywordtype">int</span> framex, framey ;
<a name="l00508"></a>00508   <span class="keywordtype">float</span> *xker, *yker ;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   <span class="keywordtype">int</span> Wx = <span class="keyword">self</span>-&gt;geom.binSizeX - 1 ;
<a name="l00511"></a>00511   <span class="keywordtype">int</span> Wy = <span class="keyword">self</span>-&gt;geom.binSizeY - 1 ;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   <span class="keywordflow">for</span> (biny = 0 ; biny &lt; <span class="keyword">self</span>-&gt;geom.numBinY ; ++biny) {
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     yker = <a class="code" href="dsift_8c.html#9a99d480cf025b9f19cc3e3ee5b010c4" title="Initialize new convolution kernel.">_vl_dsift_new_kernel</a> (self-&gt;geom.binSizeY,
<a name="l00516"></a>00516                                  self-&gt;geom.numBinY,
<a name="l00517"></a>00517                                  biny,
<a name="l00518"></a>00518                                  self-&gt;windowSize) ;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="keywordflow">for</span> (binx = 0 ; binx &lt; <span class="keyword">self</span>-&gt;geom.numBinX ; ++binx) {
<a name="l00521"></a>00521 
<a name="l00522"></a>00522       xker = <a class="code" href="dsift_8c.html#9a99d480cf025b9f19cc3e3ee5b010c4" title="Initialize new convolution kernel.">_vl_dsift_new_kernel</a>(self-&gt;geom.binSizeX,
<a name="l00523"></a>00523                                   self-&gt;geom.numBinX,
<a name="l00524"></a>00524                                   binx,
<a name="l00525"></a>00525                                   self-&gt;windowSize) ;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527       <span class="keywordflow">for</span> (bint = 0 ; bint &lt; <span class="keyword">self</span>-&gt;geom.numBinT ; ++bint) {
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <a class="code" href="imopv_8h.html#032ec58dd2542db69351e006fbac1b13" title="Convolve image along columns.">vl_imconvcol_vf</a> (self-&gt;convTmp1, self-&gt;imHeight,
<a name="l00530"></a>00530                          self-&gt;grads[bint], self-&gt;imWidth, self-&gt;imHeight,
<a name="l00531"></a>00531                          self-&gt;imWidth,
<a name="l00532"></a>00532                          yker, -Wy, +Wy, 1,
<a name="l00533"></a>00533                          <a class="code" href="imopv_8h.html#abcdd51c289c0d8db11dda9e26349a52" title="Pad by continuity.">VL_PAD_BY_CONTINUITY</a>|<a class="code" href="imopv_8h.html#2489ff30a8c5d4048038a90b640a038a" title="Transpose result.">VL_TRANSPOSE</a>) ;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <a class="code" href="imopv_8h.html#032ec58dd2542db69351e006fbac1b13" title="Convolve image along columns.">vl_imconvcol_vf</a> (self-&gt;convTmp2, self-&gt;imWidth,
<a name="l00536"></a>00536                          self-&gt;convTmp1, self-&gt;imHeight, self-&gt;imWidth,
<a name="l00537"></a>00537                          self-&gt;imHeight,
<a name="l00538"></a>00538                          xker, -Wx, +Wx, 1,
<a name="l00539"></a>00539                          <a class="code" href="imopv_8h.html#abcdd51c289c0d8db11dda9e26349a52" title="Pad by continuity.">VL_PAD_BY_CONTINUITY</a>|<a class="code" href="imopv_8h.html#2489ff30a8c5d4048038a90b640a038a" title="Transpose result.">VL_TRANSPOSE</a>) ;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541         {
<a name="l00542"></a>00542           <span class="keywordtype">float</span> *dst = <span class="keyword">self</span>-&gt;descrs
<a name="l00543"></a>00543             + bint
<a name="l00544"></a>00544             + binx * <span class="keyword">self</span>-&gt;geom.numBinT
<a name="l00545"></a>00545             + biny * (<span class="keyword">self</span>-&gt;geom.numBinX * <span class="keyword">self</span>-&gt;geom.numBinT)  ;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547           <span class="keywordtype">float</span> *src = <span class="keyword">self</span>-&gt;convTmp2 ;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549           <span class="keywordtype">int</span> frameSizeX = <span class="keyword">self</span>-&gt;geom.binSizeX * (<span class="keyword">self</span>-&gt;geom.numBinX - 1) + 1 ;
<a name="l00550"></a>00550           <span class="keywordtype">int</span> frameSizeY = <span class="keyword">self</span>-&gt;geom.binSizeY * (<span class="keyword">self</span>-&gt;geom.numBinY - 1) + 1 ;
<a name="l00551"></a>00551           <span class="keywordtype">int</span> descrSize = <a class="code" href="dsift_8h.html#eade8b18c21954f00d76f5dcb12b9bfe" title="Get descriptor size.">vl_dsift_get_descriptor_size</a> (<span class="keyword">self</span>) ;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553           <span class="keywordflow">for</span> (framey  = self-&gt;boundMinY ;
<a name="l00554"></a>00554                framey &lt;= self-&gt;boundMaxY - frameSizeY + 1 ;
<a name="l00555"></a>00555                framey += self-&gt;stepY) {
<a name="l00556"></a>00556             <span class="keywordflow">for</span> (framex  = self-&gt;boundMinX ;
<a name="l00557"></a>00557                  framex &lt;= self-&gt;boundMaxX - frameSizeX + 1 ;
<a name="l00558"></a>00558                  framex += self-&gt;stepX) {
<a name="l00559"></a>00559               *dst = src [(framex + binx * <span class="keyword">self</span>-&gt;geom.binSizeX) * 1 +
<a name="l00560"></a>00560                           (framey + biny * self-&gt;geom.binSizeY) * <span class="keyword">self</span>-&gt;imWidth]  ;
<a name="l00561"></a>00561               dst += descrSize ;
<a name="l00562"></a>00562             } <span class="comment">/* framex */</span>
<a name="l00563"></a>00563           } <span class="comment">/* framey */</span>
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566       } <span class="comment">/* for bint */</span>
<a name="l00567"></a>00567       <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a> (xker) ;
<a name="l00568"></a>00568     } <span class="comment">/* for binx */</span>
<a name="l00569"></a>00569     <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a> (yker) ;
<a name="l00570"></a>00570   } <span class="comment">/* for biny */</span>
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00578"></a>00578 VL_INLINE
<a name="l00579"></a><a class="code" href="dsift_8c.html#c06773b962840055b60556491d7b059e">00579</a> <span class="keywordtype">void</span> <a class="code" href="dsift_8c.html#c06773b962840055b60556491d7b059e" title="Process with flat window.">_vl_dsift_with_flat_window</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>* <span class="keyword">self</span>)
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581   <span class="keywordtype">int</span> binx, biny, bint ;
<a name="l00582"></a>00582   <span class="keywordtype">int</span> framex, framey ;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584   <span class="comment">/* for each orientation bin */</span>
<a name="l00585"></a>00585   <span class="keywordflow">for</span> (bint = 0 ; bint &lt; <span class="keyword">self</span>-&gt;geom.numBinT ; ++bint) {
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <a class="code" href="imopv_8h.html#4e9d44a40850d2a6f2930065d1dc3922" title="Convolve an image along the columns with a triangular kernel.">vl_imconvcoltri_vf</a> (self-&gt;convTmp1, self-&gt;imHeight,
<a name="l00588"></a>00588                         self-&gt;grads [bint], self-&gt;imWidth, self-&gt;imHeight,
<a name="l00589"></a>00589                         self-&gt;imWidth,
<a name="l00590"></a>00590                         self-&gt;geom.binSizeY, <span class="comment">/* filt size */</span>
<a name="l00591"></a>00591                         1, <span class="comment">/* subsampling step */</span>
<a name="l00592"></a>00592                         <a class="code" href="imopv_8h.html#abcdd51c289c0d8db11dda9e26349a52" title="Pad by continuity.">VL_PAD_BY_CONTINUITY</a>|<a class="code" href="imopv_8h.html#2489ff30a8c5d4048038a90b640a038a" title="Transpose result.">VL_TRANSPOSE</a>) ;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <a class="code" href="imopv_8h.html#4e9d44a40850d2a6f2930065d1dc3922" title="Convolve an image along the columns with a triangular kernel.">vl_imconvcoltri_vf</a> (self-&gt;convTmp2, self-&gt;imWidth,
<a name="l00595"></a>00595                         self-&gt;convTmp1, self-&gt;imHeight, self-&gt;imWidth,
<a name="l00596"></a>00596                         self-&gt;imHeight,
<a name="l00597"></a>00597                         self-&gt;geom.binSizeX,
<a name="l00598"></a>00598                         1,
<a name="l00599"></a>00599                         <a class="code" href="imopv_8h.html#abcdd51c289c0d8db11dda9e26349a52" title="Pad by continuity.">VL_PAD_BY_CONTINUITY</a>|<a class="code" href="imopv_8h.html#2489ff30a8c5d4048038a90b640a038a" title="Transpose result.">VL_TRANSPOSE</a>) ;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     <span class="keywordflow">for</span> (biny = 0 ; biny &lt; <span class="keyword">self</span>-&gt;geom.numBinY ; ++biny) {
<a name="l00602"></a>00602       <span class="keywordtype">float</span> wy = _vl_dsift_get_bin_window_mean (self-&gt;geom.binSizeY,
<a name="l00603"></a>00603                                                 self-&gt;geom.numBinY,
<a name="l00604"></a>00604                                                 biny,
<a name="l00605"></a>00605                                                 self-&gt;windowSize) ;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607       <span class="comment">/* The convolution function uses triangualr wave with unit integral (hence height</span>
<a name="l00608"></a>00608 <span class="comment">       * equal to half the bin size). Instead</span>
<a name="l00609"></a>00609 <span class="comment">       * for SIFT the triangular wave is used as a partition function and must</span>
<a name="l00610"></a>00610 <span class="comment">       * have unit maximum. We compoensate for this by multiplying the result</span>
<a name="l00611"></a>00611 <span class="comment">       * by the bin size.</span>
<a name="l00612"></a>00612 <span class="comment">       */</span>
<a name="l00613"></a>00613 
<a name="l00614"></a>00614       wy *= <span class="keyword">self</span>-&gt;geom.binSizeY ;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616       <span class="keywordflow">for</span> (binx = 0 ; binx &lt; <span class="keyword">self</span>-&gt;geom.numBinX ; ++binx) {
<a name="l00617"></a>00617         <span class="keywordtype">float</span> w ;
<a name="l00618"></a>00618         <span class="keywordtype">float</span> wx = _vl_dsift_get_bin_window_mean (self-&gt;geom.binSizeX,
<a name="l00619"></a>00619                                                   self-&gt;geom.numBinX,
<a name="l00620"></a>00620                                                   binx,
<a name="l00621"></a>00621                                                   self-&gt;windowSize) ;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         <span class="keywordtype">float</span> *dst = <span class="keyword">self</span>-&gt;descrs
<a name="l00624"></a>00624           + bint
<a name="l00625"></a>00625           + binx * <span class="keyword">self</span>-&gt;geom.numBinT
<a name="l00626"></a>00626           + biny * (<span class="keyword">self</span>-&gt;geom.numBinX * <span class="keyword">self</span>-&gt;geom.numBinT)  ;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         <span class="keywordtype">float</span> *src = <span class="keyword">self</span>-&gt;convTmp2 ;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         <span class="keywordtype">int</span> frameSizeX = <span class="keyword">self</span>-&gt;geom.binSizeX * (<span class="keyword">self</span>-&gt;geom.numBinX - 1) + 1 ;
<a name="l00631"></a>00631         <span class="keywordtype">int</span> frameSizeY = <span class="keyword">self</span>-&gt;geom.binSizeY * (<span class="keyword">self</span>-&gt;geom.numBinY - 1) + 1 ;
<a name="l00632"></a>00632         <span class="keywordtype">int</span> descrSize = <a class="code" href="dsift_8h.html#eade8b18c21954f00d76f5dcb12b9bfe" title="Get descriptor size.">vl_dsift_get_descriptor_size</a> (<span class="keyword">self</span>) ;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         wx *= <span class="keyword">self</span>-&gt;geom.binSizeX ;
<a name="l00635"></a>00635         w = wx * wy ;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="keywordflow">for</span> (framey  = self-&gt;boundMinY ;
<a name="l00638"></a>00638              framey &lt;= self-&gt;boundMaxY - frameSizeY + 1 ;
<a name="l00639"></a>00639              framey += self-&gt;stepY) {
<a name="l00640"></a>00640           <span class="keywordflow">for</span> (framex  = self-&gt;boundMinX ;
<a name="l00641"></a>00641                framex &lt;= self-&gt;boundMaxX - frameSizeX + 1 ;
<a name="l00642"></a>00642                framex += self-&gt;stepX) {
<a name="l00643"></a>00643             *dst = w * src [(framex + binx * <span class="keyword">self</span>-&gt;geom.binSizeX) * 1 +
<a name="l00644"></a>00644                             (framey + biny * self-&gt;geom.binSizeY) * <span class="keyword">self</span>-&gt;imWidth]  ;
<a name="l00645"></a>00645             dst += descrSize ;
<a name="l00646"></a>00646           } <span class="comment">/* framex */</span>
<a name="l00647"></a>00647         } <span class="comment">/* framey */</span>
<a name="l00648"></a>00648       } <span class="comment">/* binx */</span>
<a name="l00649"></a>00649     } <span class="comment">/* biny */</span>
<a name="l00650"></a>00650   } <span class="comment">/* bint */</span>
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00660"></a><a class="code" href="dsift_8h.html#e2ae602b4923cbc79f8a4ed211f92f85">00660</a> <span class="keywordtype">void</span> <a class="code" href="dsift_8c.html#09d5525ad7e16e2b9f3f1b9d273c85f6" title="Compute keypoints and descriptors.">vl_dsift_process</a> (<a class="code" href="structVlDsiftFilter__.html" title="Dense SIFT filter.">VlDsiftFilter</a>* <span class="keyword">self</span>, <span class="keywordtype">float</span> <span class="keyword">const</span>* im)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662   <span class="keywordtype">int</span> t, x, y ;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664   <span class="comment">/* update buffers */</span>
<a name="l00665"></a>00665   <a class="code" href="dsift_8c.html#8b3119bdf4dd078826d1fa70231184fe" title="Allocate internal buffers.">_vl_dsift_alloc_buffers</a> (<span class="keyword">self</span>) ;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667   <span class="comment">/* clear integral images */</span>
<a name="l00668"></a>00668   <span class="keywordflow">for</span> (t = 0 ; t &lt; <span class="keyword">self</span>-&gt;geom.numBinT ; ++t)
<a name="l00669"></a>00669     memset (self-&gt;grads[t], 0,
<a name="l00670"></a>00670             <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * self-&gt;imWidth * self-&gt;imHeight) ;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="preprocessor">#undef at</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span><span class="preprocessor">#define at(x,y) (im[(y)*self-&gt;imWidth+(x)])</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>
<a name="l00675"></a>00675   <span class="comment">/* Compute gradients, their norm, and their angle */</span>
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   <span class="keywordflow">for</span> (y = 0 ; y &lt; <span class="keyword">self</span>-&gt;imHeight ; ++ y) {
<a name="l00678"></a>00678     <span class="keywordflow">for</span> (x = 0 ; x &lt; <span class="keyword">self</span>-&gt;imWidth ; ++ x) {
<a name="l00679"></a>00679       <span class="keywordtype">float</span> gx, gy ;
<a name="l00680"></a>00680       <span class="keywordtype">float</span> angle, mod, nt, rbint ;
<a name="l00681"></a>00681       <span class="keywordtype">int</span> bint ;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       <span class="comment">/* y derivative */</span>
<a name="l00684"></a>00684       <span class="keywordflow">if</span> (y == 0) {
<a name="l00685"></a>00685         gy = at(x,y+1) - at(x,y) ;
<a name="l00686"></a>00686       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y == self-&gt;imHeight - 1) {
<a name="l00687"></a>00687         gy = at(x,y) - at(x,y-1) ;
<a name="l00688"></a>00688       } <span class="keywordflow">else</span> {
<a name="l00689"></a>00689         gy = 0.5F * (at(x,y+1) - at(x,y-1)) ;
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692       <span class="comment">/* x derivative */</span>
<a name="l00693"></a>00693       <span class="keywordflow">if</span> (x == 0) {
<a name="l00694"></a>00694         gx = at(x+1,y) - at(x,y) ;
<a name="l00695"></a>00695       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x == self-&gt;imWidth - 1) {
<a name="l00696"></a>00696         gx = at(x,y) - at(x-1,y) ;
<a name="l00697"></a>00697       } <span class="keywordflow">else</span> {
<a name="l00698"></a>00698         gx = 0.5F * (at(x+1,y) - at(x-1,y)) ;
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701       <span class="comment">/* angle and modulus */</span>
<a name="l00702"></a>00702       angle = <a class="code" href="mathop_8h.html#83b506c15839a1b6b07ed81e20f2906e" title="Fast atan2 approximation.">vl_fast_atan2_f</a> (gy,gx) ;
<a name="l00703"></a>00703       mod = <a class="code" href="mathop_8h.html#fd17414c0bd6edce9280378201a24847" title="Fast sqrt approximation.">vl_fast_sqrt_f</a> (gx*gx + gy*gy) ;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705       <span class="comment">/* quantize angle */</span>
<a name="l00706"></a>00706       nt = <a class="code" href="mathop_8h.html#779371154b6f6c1a0f9bf51ad9afcd07" title="Fast mod(x, 2 * VL_PI).">vl_mod_2pi_f</a> (angle) * (<span class="keyword">self</span>-&gt;geom.numBinT / (2*<a class="code" href="mathop_8h.html#19d43a5e0c355df553ebe825208a4cc1" title="Pi (math constant).">VL_PI</a>)) ;
<a name="l00707"></a>00707       bint = <a class="code" href="mathop_8h.html#0a641bb83f3aa7db107a51f63a534b52" title="Fast (int) floor(x).">vl_floor_f</a> (nt) ;
<a name="l00708"></a>00708       rbint = nt - bint ;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710       <span class="comment">/* write it back */</span>
<a name="l00711"></a>00711       <span class="keyword">self</span>-&gt;grads [(bint    ) % self-&gt;geom.numBinT][x + y * self-&gt;imWidth] = (1 - rbint) * mod ;
<a name="l00712"></a>00712       <span class="keyword">self</span>-&gt;grads [(bint + 1) % self-&gt;geom.numBinT][x + y * self-&gt;imWidth] = (    rbint) * mod ;
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714   }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="keywordflow">if</span> (self-&gt;useFlatWindow) {
<a name="l00717"></a>00717     <a class="code" href="dsift_8c.html#c06773b962840055b60556491d7b059e" title="Process with flat window.">_vl_dsift_with_flat_window</a>(<span class="keyword">self</span>) ;
<a name="l00718"></a>00718   } <span class="keywordflow">else</span> {
<a name="l00719"></a>00719     <a class="code" href="dsift_8c.html#454f20230291e23285448813b230a0eb" title="Process with Gaussian window.">_vl_dsift_with_gaussian_window</a>(<span class="keyword">self</span>) ;
<a name="l00720"></a>00720   }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   {
<a name="l00723"></a>00723     <a class="code" href="structVlDsiftKeypoint__.html" title="Dense SIFT keypoint.">VlDsiftKeypoint</a>* frameIter = <span class="keyword">self</span>-&gt;frames ;
<a name="l00724"></a>00724     <span class="keywordtype">float</span> * descrIter = <span class="keyword">self</span>-&gt;descrs ;
<a name="l00725"></a>00725     <span class="keywordtype">int</span> framex, framey, bint ;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordtype">int</span> frameSizeX = <span class="keyword">self</span>-&gt;geom.binSizeX * (<span class="keyword">self</span>-&gt;geom.numBinX - 1) + 1 ;
<a name="l00728"></a>00728     <span class="keywordtype">int</span> frameSizeY = <span class="keyword">self</span>-&gt;geom.binSizeY * (<span class="keyword">self</span>-&gt;geom.numBinY - 1) + 1 ;
<a name="l00729"></a>00729     <span class="keywordtype">int</span> descrSize = <a class="code" href="dsift_8h.html#eade8b18c21954f00d76f5dcb12b9bfe" title="Get descriptor size.">vl_dsift_get_descriptor_size</a> (<span class="keyword">self</span>) ;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="keywordtype">float</span> deltaCenterX = 0.5F * <span class="keyword">self</span>-&gt;geom.binSizeX * (<span class="keyword">self</span>-&gt;geom.numBinX - 1) ;
<a name="l00732"></a>00732     <span class="keywordtype">float</span> deltaCenterY = 0.5F * <span class="keyword">self</span>-&gt;geom.binSizeY * (<span class="keyword">self</span>-&gt;geom.numBinY - 1) ;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordtype">float</span> normConstant = frameSizeX * frameSizeY ;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">for</span> (framey  = self-&gt;boundMinY ;
<a name="l00737"></a>00737          framey &lt;= self-&gt;boundMaxY - frameSizeY + 1 ;
<a name="l00738"></a>00738          framey += self-&gt;stepY) {
<a name="l00739"></a>00739 
<a name="l00740"></a>00740       <span class="keywordflow">for</span> (framex  = self-&gt;boundMinX ;
<a name="l00741"></a>00741            framex &lt;= self-&gt;boundMaxX - frameSizeX + 1 ;
<a name="l00742"></a>00742            framex += self-&gt;stepX) {
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         frameIter-&gt;<a class="code" href="structVlDsiftKeypoint__.html#e50979c322397703dc25ba0c722b6fd7">x</a>    = framex + deltaCenterX ;
<a name="l00745"></a>00745         frameIter-&gt;<a class="code" href="structVlDsiftKeypoint__.html#10125676410606384f4dfb04c9e046a3">y</a>    = framey + deltaCenterY ;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747         <span class="comment">/* mass */</span>
<a name="l00748"></a>00748         {
<a name="l00749"></a>00749           <span class="keywordtype">float</span> mass = 0 ;
<a name="l00750"></a>00750           <span class="keywordflow">for</span> (bint = 0 ; bint &lt; descrSize ; ++ bint)
<a name="l00751"></a>00751             mass += descrIter[bint] ;
<a name="l00752"></a>00752           mass /= normConstant ;
<a name="l00753"></a>00753           frameIter-&gt;<a class="code" href="structVlDsiftKeypoint__.html#f55f2c905d9287b31e25b455bb89d5bd">norm</a> = mass ;
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="comment">/* L2 normalize */</span>
<a name="l00757"></a>00757         <a class="code" href="dsift_8c.html#1a8319889b1833c105817eeb07f85675" title="Normalize histogram.">_vl_dsift_normalize_histogram</a> (descrIter, descrIter + descrSize) ;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <span class="comment">/* clamp */</span>
<a name="l00760"></a>00760         <span class="keywordflow">for</span>(bint = 0 ; bint &lt; descrSize ; ++ bint)
<a name="l00761"></a>00761           <span class="keywordflow">if</span> (descrIter[bint] &gt; 0.2F) descrIter[bint] = 0.2F ;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763         <span class="comment">/* L2 normalize */</span>
<a name="l00764"></a>00764         <a class="code" href="dsift_8c.html#1a8319889b1833c105817eeb07f85675" title="Normalize histogram.">_vl_dsift_normalize_histogram</a> (descrIter, descrIter + descrSize) ;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         frameIter ++ ;
<a name="l00767"></a>00767         descrIter += descrSize ;
<a name="l00768"></a>00768       } <span class="comment">/* for framex */</span>
<a name="l00769"></a>00769     } <span class="comment">/* for framey */</span>
<a name="l00770"></a>00770   }
<a name="l00771"></a>00771 }
</pre></div></div>
     <!-- Doc Here -->
    </div>
   
   </div>
   <div class="clear">&nbsp;</div>
  </div> <!-- pagebody -->
  <div id="footer">
   &copy; 2005-09 Andrea Vedaldi and Brian Fulkerson
  </div> <!-- footer -->
  
  <!-- Google Analytics Begins -->
  <script xml:space="preserve" type="text/javascript">
   //<![CDATA[
    var localre = /vlfeat.org/;
    if(document.location.host.search(localre) != -1)
    {
   var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
   document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
   }
   //]]>
  </script>
  <script xml:space="preserve" type="text/javascript">
    //<![CDATA[
    var localre = /vlfeat.org/;
    if(document.location.host.search(localre) != -1)
    {

   try {
   var pageTracker = _gat._getTracker("UA-4936091-2");
   pageTracker._trackPageview();
   } catch(err) {}

   }
   //]]>
  </script>
  <!-- Google Analytics Ends -->
 </body>
</html>

 
