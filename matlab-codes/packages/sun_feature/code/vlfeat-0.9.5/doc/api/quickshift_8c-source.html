<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">   
 <meta>
  <!-- Stylesheets -->
  <link href="../web.css" type="text/css" rel="stylesheet"></link>
  <title>VLFeat - Documentation - C API</title>
   
  
  <!-- Scripts-->
  
 </meta>
 
 <!-- Body Start -->
 <body>
  <div id="header">
   <!-- Google CSE Search Box Begins -->
   <form action="http://www.vlfeat.org/search.html" method="get" id="cse-search-box" enctype="application/x-www-form-urlencoded">
    <div>
     <input type="hidden" name="cx" value="003215582122030917471:oq23albfeam"></input>
     <input type="hidden" name="cof" value="FORID:11"></input>
     <input type="hidden" name="ie" value="UTF-8"></input>
     <input type="text" name="q" size="31"></input>
     <input type="submit" name="sa" value="Search"></input>
    </div>
   </form>
   <script src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" xml:space="preserve" type="text/javascript"></script>
   <!-- Google CSE Search Box Ends -->
   <h1>VLFeat.org</h1>
  </div>
  <div id="headbanner">
   Documentation - C API
  </div>
  <div id="pagebody">
   <div id="sidebar"> <!-- Navigation Start -->
    <ul>
<li><a href="../index.html">Home</a>
</li>
<li><a href="../download.html">Download</a>
</li>
<li><a href="../doc.html">Documentation</a>
<ul>
<li><a href="../mdoc/mdoc.html">Matlab API</a>
</li>
<li><a href="index.html" class='active' >C API</a>
</li>
<li><a href="../man/man.html">Man pages</a>
</li>
</ul></li>
<li><a href="../overview/tut.html">Tutorials</a>
</li>
</ul>

   </div> <!-- sidebar -->
   <div id="content">
    
    <div class="doxygen">
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>quickshift.c</h1><a href="quickshift_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00008"></a>00008 <span class="comment">/* AUTORIGHTS</span>
<a name="l00009"></a>00009 <span class="comment">Copyright (C) 2007-09 Andrea Vedaldi and Brian Fulkerson</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">This file is part of VLFeat, available in the terms of the GNU</span>
<a name="l00012"></a>00012 <span class="comment">General Public License version 2.</span>
<a name="l00013"></a>00013 <span class="comment">*/</span>
<a name="l00014"></a>00014 
<a name="l00120"></a>00120 <span class="preprocessor">#include "<a class="code" href="quickshift_8h.html" title="Quick shift image segmentation.">quickshift.h</a>"</span>
<a name="l00121"></a>00121 <span class="preprocessor">#include "<a class="code" href="mathop_8h.html" title="Math operations.">mathop.h</a>"</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00124"></a>00124 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00125"></a>00125 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00149"></a>00149 VL_INLINE
<a name="l00150"></a>00150 <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>
<a name="l00151"></a><a class="code" href="quickshift_8c.html#5b631210954fadee8307dbe3e0c390a4">00151</a> <a class="code" href="quickshift_8c.html#5b631210954fadee8307dbe3e0c390a4" title="Computes the accumulated channel L2 distance between i,j + the distance between i...">vl_quickshift_distance</a>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> <span class="keyword">const</span> * I, 
<a name="l00152"></a>00152          <span class="keywordtype">int</span> N1, <span class="keywordtype">int</span> N2, <span class="keywordtype">int</span> K,
<a name="l00153"></a>00153          <span class="keywordtype">int</span> i1, <span class="keywordtype">int</span> i2,
<a name="l00154"></a>00154          <span class="keywordtype">int</span> j1, <span class="keywordtype">int</span> j2) 
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> dist = 0 ;
<a name="l00157"></a>00157   <span class="keywordtype">int</span> d1 = j1 - i1 ;
<a name="l00158"></a>00158   <span class="keywordtype">int</span> d2 = j2 - i2 ;
<a name="l00159"></a>00159   <span class="keywordtype">int</span> k ;
<a name="l00160"></a>00160   dist += d1*d1 + d2*d2 ;
<a name="l00161"></a>00161   <span class="comment">/* For k = 0...K-1, d+= L2 distance between I(i1,i2,k) and </span>
<a name="l00162"></a>00162 <span class="comment">   * I(j1,j2,k) */</span>
<a name="l00163"></a>00163   <span class="keywordflow">for</span> (k = 0 ; k &lt; K ; ++k) {
<a name="l00164"></a>00164     <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> d = 
<a name="l00165"></a>00165       I [i1 + N1 * i2 + (N1*N2) * k] - 
<a name="l00166"></a>00166       I [j1 + N1 * j2 + (N1*N2) * k] ;
<a name="l00167"></a>00167     dist += d*d ;
<a name="l00168"></a>00168   }
<a name="l00169"></a>00169   <span class="keywordflow">return</span> dist ;
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00193"></a>00193 VL_INLINE
<a name="l00194"></a>00194 <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>
<a name="l00195"></a><a class="code" href="quickshift_8c.html#7c255531567c9fc0901d2838cf187506">00195</a> <a class="code" href="quickshift_8c.html#7c255531567c9fc0901d2838cf187506" title="Computes the accumulated channel inner product between i,j + the distance between...">vl_quickshift_inner</a>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> <span class="keyword">const</span> * I, 
<a name="l00196"></a>00196       <span class="keywordtype">int</span> N1, <span class="keywordtype">int</span> N2, <span class="keywordtype">int</span> K,
<a name="l00197"></a>00197       <span class="keywordtype">int</span> i1, <span class="keywordtype">int</span> i2,
<a name="l00198"></a>00198       <span class="keywordtype">int</span> j1, <span class="keywordtype">int</span> j2) 
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> ker = 0 ;
<a name="l00201"></a>00201   <span class="keywordtype">int</span> k ;
<a name="l00202"></a>00202   ker += i1*j1 + i2*j2 ;
<a name="l00203"></a>00203   <span class="keywordflow">for</span> (k = 0 ; k &lt; K ; ++k) {
<a name="l00204"></a>00204     ker += 
<a name="l00205"></a>00205       I [i1 + N1 * i2 + (N1*N2) * k] *
<a name="l00206"></a>00206       I [j1 + N1 * j2 + (N1*N2) * k] ;
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208   <span class="keywordflow">return</span> ker ;
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00221"></a>00221 VL_EXPORT
<a name="l00222"></a>00222 <a class="code" href="struct__VlQS.html" title="quick shift results">VlQS</a> *
<a name="l00223"></a><a class="code" href="quickshift_8h.html#2c2cebc768665438e72ae0df9d4b8f90">00223</a> <a class="code" href="quickshift_8c.html#ba6d1de6ef02159d32b150d0cbd42e43" title="Create a quick shift object.">vl_quickshift_new</a>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> <span class="keyword">const</span> * image, <span class="keywordtype">int</span> <a class="code" href="struct__VlPgmImage.html#6a759d2567cd2621c203f95df9f86155">height</a>, <span class="keywordtype">int</span> <a class="code" href="struct__VlPgmImage.html#cefc89911cb45ea3ca09a439e6249072">width</a>,
<a name="l00224"></a>00224                        <span class="keywordtype">int</span> channels)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226   <a class="code" href="struct__VlQS.html" title="quick shift results">VlQS</a> * q = <a class="code" href="generic_8h.html#e28d261fc7cc26f1457b171d842b53ab" title="Call customizable malloc function.">vl_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct__VlQS.html" title="quick shift results">VlQS</a>));
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   q-&gt;<a class="code" href="struct__VlQS.html#196728c809c801edf185e3d6fd2832e1">image</a>    = (<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *)image;
<a name="l00229"></a>00229   q-&gt;<a class="code" href="struct__VlQS.html#f4274222e9b478481051a62e7e0527f1">height</a>   = height;
<a name="l00230"></a>00230   q-&gt;<a class="code" href="struct__VlQS.html#cc79c68f5c929537252ea69fd60ecfc1">width</a>    = width;
<a name="l00231"></a>00231   q-&gt;<a class="code" href="struct__VlQS.html#102525de1ed872c106c5e29736b454ae">channels</a> = channels;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   q-&gt;<a class="code" href="struct__VlQS.html#e5f52b8b0f245ee265e3841711eb3c94">medoid</a>   = <a class="code" href="host_8h.html#bce143a5a9b51d987a74f2ad30046520" title="false (0) constant">VL_FALSE</a>;
<a name="l00234"></a>00234   q-&gt;<a class="code" href="struct__VlQS.html#add609c3a3e008dca8b44554a00bd3ee">tau</a>      = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(height,width)/50;
<a name="l00235"></a>00235   q-&gt;<a class="code" href="struct__VlQS.html#1fc8374fad484c1df4fd8f5cba428672">sigma</a>    = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(2, q-&gt;<a class="code" href="struct__VlQS.html#add609c3a3e008dca8b44554a00bd3ee">tau</a>/3);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   q-&gt;<a class="code" href="struct__VlQS.html#216a3484bfabf0464f38bd6aed5f4af2">dists</a>    = <a class="code" href="generic_8h.html#93ff990a07af5b4b69bbde7c8e021e28" title="Call customizable calloc function.">vl_calloc</a>(height*width, <span class="keyword">sizeof</span>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>));
<a name="l00238"></a>00238   q-&gt;<a class="code" href="struct__VlQS.html#78f7b05c1ee66136c396c6b706dfa6b8">parents</a>  = <a class="code" href="generic_8h.html#93ff990a07af5b4b69bbde7c8e021e28" title="Call customizable calloc function.">vl_calloc</a>(height*width, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); 
<a name="l00239"></a>00239   q-&gt;<a class="code" href="struct__VlQS.html#f814b044240b28c003bf69266afa1990">density</a>  = <a class="code" href="generic_8h.html#93ff990a07af5b4b69bbde7c8e021e28" title="Call customizable calloc function.">vl_calloc</a>(height*width, <span class="keyword">sizeof</span>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>)) ;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="keywordflow">return</span> q;
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00249"></a>00249 VL_EXPORT
<a name="l00250"></a><a class="code" href="quickshift_8h.html#05bf3f111b773be56885a04b5a4acec3">00250</a> <span class="keywordtype">void</span> <a class="code" href="quickshift_8c.html#05bf3f111b773be56885a04b5a4acec3" title="Create a quick shift objet.">vl_quickshift_process</a>(<a class="code" href="struct__VlQS.html" title="quick shift results">VlQS</a> * q)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> <span class="keyword">const</span> *I = q-&gt;<a class="code" href="struct__VlQS.html#196728c809c801edf185e3d6fd2832e1">image</a>;
<a name="l00253"></a>00253   <span class="keywordtype">int</span>        *parents = q-&gt;<a class="code" href="struct__VlQS.html#78f7b05c1ee66136c396c6b706dfa6b8">parents</a>;
<a name="l00254"></a>00254   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *E = q-&gt;<a class="code" href="struct__VlQS.html#f814b044240b28c003bf69266afa1990">density</a>;
<a name="l00255"></a>00255   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *dists = q-&gt;<a class="code" href="struct__VlQS.html#216a3484bfabf0464f38bd6aed5f4af2">dists</a>; 
<a name="l00256"></a>00256   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *M = 0, *n = 0 ;
<a name="l00257"></a>00257   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> sigma = q-&gt;<a class="code" href="struct__VlQS.html#1fc8374fad484c1df4fd8f5cba428672">sigma</a> ;
<a name="l00258"></a>00258   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> tau = q-&gt;<a class="code" href="struct__VlQS.html#add609c3a3e008dca8b44554a00bd3ee">tau</a>;
<a name="l00259"></a>00259   <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> tau2 = tau*tau;
<a name="l00260"></a>00260   
<a name="l00261"></a>00261   <span class="keywordtype">int</span> K = q-&gt;<a class="code" href="struct__VlQS.html#102525de1ed872c106c5e29736b454ae">channels</a>, d;
<a name="l00262"></a>00262   <span class="keywordtype">int</span> N1 = q-&gt;<a class="code" href="struct__VlQS.html#f4274222e9b478481051a62e7e0527f1">height</a>, N2 = q-&gt;<a class="code" href="struct__VlQS.html#cc79c68f5c929537252ea69fd60ecfc1">width</a>;
<a name="l00263"></a>00263   <span class="keywordtype">int</span> i1,i2, j1,j2, R, tR;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265   d = 2 + K ; <span class="comment">/* Total dimensions include spatial component (x,y) */</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   <span class="keywordflow">if</span> (q-&gt;<a class="code" href="struct__VlQS.html#e5f52b8b0f245ee265e3841711eb3c94">medoid</a>) { <span class="comment">/* n and M are only used in mediod shift */</span>
<a name="l00268"></a>00268     M = (<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *) <a class="code" href="generic_8h.html#93ff990a07af5b4b69bbde7c8e021e28" title="Call customizable calloc function.">vl_calloc</a>(N1*N2*d, <span class="keyword">sizeof</span>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>)) ;
<a name="l00269"></a>00269     n = (<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> *) <a class="code" href="generic_8h.html#93ff990a07af5b4b69bbde7c8e021e28" title="Call customizable calloc function.">vl_calloc</a>(N1*N2,   <span class="keyword">sizeof</span>(<a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a>)) ;
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   R = (int) ceil (3 * sigma) ;
<a name="l00273"></a>00273   tR = (int) ceil (tau) ;
<a name="l00274"></a>00274   
<a name="l00275"></a>00275   <span class="comment">/* -----------------------------------------------------------------</span>
<a name="l00276"></a>00276 <span class="comment">   *                                                                 n </span>
<a name="l00277"></a>00277 <span class="comment">   * -------------------------------------------------------------- */</span>
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <span class="comment">/* If we are doing medoid shift, initialize n to the inner product of the</span>
<a name="l00280"></a>00280 <span class="comment">   * image with itself</span>
<a name="l00281"></a>00281 <span class="comment">   */</span>
<a name="l00282"></a>00282   <span class="keywordflow">if</span> (n) { 
<a name="l00283"></a>00283     <span class="keywordflow">for</span> (i2 = 0 ; i2 &lt; N2 ; ++ i2) {
<a name="l00284"></a>00284       <span class="keywordflow">for</span> (i1 = 0 ; i1 &lt; N1 ; ++ i1) {        
<a name="l00285"></a>00285         n [i1 + N1 * i2] = <a class="code" href="quickshift_8c.html#7c255531567c9fc0901d2838cf187506" title="Computes the accumulated channel inner product between i,j + the distance between...">vl_quickshift_inner</a>(I,N1,N2,K,
<a name="l00286"></a>00286                                                i1,i2,
<a name="l00287"></a>00287                                                i1,i2) ;
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290   }
<a name="l00291"></a>00291   
<a name="l00292"></a>00292   <span class="comment">/* -----------------------------------------------------------------</span>
<a name="l00293"></a>00293 <span class="comment">   *                                                 E = - [oN'*F]', M</span>
<a name="l00294"></a>00294 <span class="comment">   * -------------------------------------------------------------- */</span>
<a name="l00295"></a>00295   
<a name="l00296"></a>00296   <span class="comment">/* </span>
<a name="l00297"></a>00297 <span class="comment">     D_ij = d(x_i,x_j)</span>
<a name="l00298"></a>00298 <span class="comment">     E_ij = exp(- .5 * D_ij / sigma^2) ;</span>
<a name="l00299"></a>00299 <span class="comment">     F_ij = - E_ij             </span>
<a name="l00300"></a>00300 <span class="comment">     E_i  = sum_j E_ij</span>
<a name="l00301"></a>00301 <span class="comment">     M_di = sum_j X_j F_ij</span>
<a name="l00302"></a>00302 <span class="comment"></span>
<a name="l00303"></a>00303 <span class="comment">     E is the parzen window estimate of the density</span>
<a name="l00304"></a>00304 <span class="comment">     0 = dissimilar to everything, windowsize = identical</span>
<a name="l00305"></a>00305 <span class="comment">  */</span>
<a name="l00306"></a>00306   
<a name="l00307"></a>00307   <span class="keywordflow">for</span> (i2 = 0 ; i2 &lt; N2 ; ++ i2) {
<a name="l00308"></a>00308     <span class="keywordflow">for</span> (i1 = 0 ; i1 &lt; N1 ; ++ i1) {
<a name="l00309"></a>00309       
<a name="l00310"></a>00310       <span class="keywordtype">int</span> j1min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i1 - R, 0   ) ;
<a name="l00311"></a>00311       <span class="keywordtype">int</span> j1max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i1 + R, N1-1) ;
<a name="l00312"></a>00312       <span class="keywordtype">int</span> j2min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i2 - R, 0   ) ;
<a name="l00313"></a>00313       <span class="keywordtype">int</span> j2max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i2 + R, N2-1) ;      
<a name="l00314"></a>00314       
<a name="l00315"></a>00315       <span class="comment">/* For each pixel in the window compute the distance between it and the</span>
<a name="l00316"></a>00316 <span class="comment">       * source pixel */</span>
<a name="l00317"></a>00317       <span class="keywordflow">for</span> (j2 = j2min ; j2 &lt;= j2max ; ++ j2) {
<a name="l00318"></a>00318         <span class="keywordflow">for</span> (j1 = j1min ; j1 &lt;= j1max ; ++ j1) {
<a name="l00319"></a>00319           <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> Dij = <a class="code" href="quickshift_8c.html#5b631210954fadee8307dbe3e0c390a4" title="Computes the accumulated channel L2 distance between i,j + the distance between i...">vl_quickshift_distance</a>(I,N1,N2,K, i1,i2, j1,j2) ;          
<a name="l00320"></a>00320           <span class="comment">/* Make distance a similarity */</span> 
<a name="l00321"></a>00321           <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> Fij = - exp(- Dij / (2*sigma*sigma)) ;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323           <span class="comment">/* E is E_i above */</span>
<a name="l00324"></a>00324           E [i1 + N1 * i2] -= Fij ;
<a name="l00325"></a>00325           
<a name="l00326"></a>00326           <span class="keywordflow">if</span> (M) {
<a name="l00327"></a>00327             <span class="comment">/* Accumulate votes for the median */</span>
<a name="l00328"></a>00328             <span class="keywordtype">int</span> k ;
<a name="l00329"></a>00329             M [i1 + N1*i2 + (N1*N2) * 0] += j1 * Fij ;
<a name="l00330"></a>00330             M [i1 + N1*i2 + (N1*N2) * 1] += j2 * Fij ;
<a name="l00331"></a>00331             <span class="keywordflow">for</span> (k = 0 ; k &lt; K ; ++k) {
<a name="l00332"></a>00332               M [i1 + N1*i2 + (N1*N2) * (k+2)] += 
<a name="l00333"></a>00333                 I [j1 + N1*j2 + (N1*N2) * k] * Fij ;
<a name="l00334"></a>00334             }
<a name="l00335"></a>00335           } 
<a name="l00336"></a>00336           
<a name="l00337"></a>00337         } <span class="comment">/* j1 */</span> 
<a name="l00338"></a>00338       } <span class="comment">/* j2 */</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     }  <span class="comment">/* i1 */</span>
<a name="l00341"></a>00341   } <span class="comment">/* i2 */</span>
<a name="l00342"></a>00342   
<a name="l00343"></a>00343   <span class="comment">/* -----------------------------------------------------------------</span>
<a name="l00344"></a>00344 <span class="comment">   *                                               Find best neighbors</span>
<a name="l00345"></a>00345 <span class="comment">   * -------------------------------------------------------------- */</span>
<a name="l00346"></a>00346   
<a name="l00347"></a>00347   <span class="keywordflow">if</span> (q-&gt;<a class="code" href="struct__VlQS.html#e5f52b8b0f245ee265e3841711eb3c94">medoid</a>) {
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     <span class="comment">/* </span>
<a name="l00350"></a>00350 <span class="comment">       Qij = - nj Ei - 2 sum_k Gjk Mik</span>
<a name="l00351"></a>00351 <span class="comment">       n is I.^2</span>
<a name="l00352"></a>00352 <span class="comment">    */</span>
<a name="l00353"></a>00353     
<a name="l00354"></a>00354     <span class="comment">/* medoid shift */</span>
<a name="l00355"></a>00355     <span class="keywordflow">for</span> (i2 = 0 ; i2 &lt; N2 ; ++i2) {
<a name="l00356"></a>00356       <span class="keywordflow">for</span> (i1 = 0 ; i1 &lt; N1 ; ++i1) {
<a name="l00357"></a>00357         
<a name="l00358"></a>00358         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> sc_best = 0  ;
<a name="l00359"></a>00359         <span class="comment">/* j1/j2 best are the best indicies for each i */</span>
<a name="l00360"></a>00360         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> j1_best = i1 ;
<a name="l00361"></a>00361         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> j2_best = i2 ; 
<a name="l00362"></a>00362         
<a name="l00363"></a>00363         <span class="keywordtype">int</span> j1min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i1 - R, 0   ) ;
<a name="l00364"></a>00364         <span class="keywordtype">int</span> j1max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i1 + R, N1-1) ;
<a name="l00365"></a>00365         <span class="keywordtype">int</span> j2min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i2 - R, 0   ) ;
<a name="l00366"></a>00366         <span class="keywordtype">int</span> j2max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i2 + R, N2-1) ;      
<a name="l00367"></a>00367         
<a name="l00368"></a>00368         <span class="keywordflow">for</span> (j2 = j2min ; j2 &lt;= j2max ; ++ j2) {
<a name="l00369"></a>00369           <span class="keywordflow">for</span> (j1 = j1min ; j1 &lt;= j1max ; ++ j1) {            
<a name="l00370"></a>00370             
<a name="l00371"></a>00371             <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> Qij = - n [j1 + j2 * N1] * E [i1 + i2 * N1] ;
<a name="l00372"></a>00372             <span class="keywordtype">int</span> k ;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374             Qij -= 2 * j1 * M [i1 + i2 * N1 + (N1*N2) * 0] ;
<a name="l00375"></a>00375             Qij -= 2 * j2 * M [i1 + i2 * N1 + (N1*N2) * 1] ;
<a name="l00376"></a>00376             <span class="keywordflow">for</span> (k = 0 ; k &lt; K ; ++k) {
<a name="l00377"></a>00377               Qij -= 2 * 
<a name="l00378"></a>00378                 I [j1 + j2 * N1 + (N1*N2) * k] *
<a name="l00379"></a>00379                 M [i1 + i2 * N1 + (N1*N2) * (k + 2)] ;
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381             
<a name="l00382"></a>00382             <span class="keywordflow">if</span> (Qij &gt; sc_best) {
<a name="l00383"></a>00383               sc_best = Qij ;
<a name="l00384"></a>00384               j1_best = j1 ;
<a name="l00385"></a>00385               j2_best = j2 ;
<a name="l00386"></a>00386             }
<a name="l00387"></a>00387           }
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <span class="comment">/* parents_i is the linear index of j which is the best pair (in matlab</span>
<a name="l00391"></a>00391 <span class="comment">         * notation</span>
<a name="l00392"></a>00392 <span class="comment">         * dists_i is the score of the best match</span>
<a name="l00393"></a>00393 <span class="comment">         */</span>
<a name="l00394"></a>00394         parents [i1 + N1 * i2] = j1_best + N1 * j2_best + 1 ;
<a name="l00395"></a>00395         dists[i1 + N1 * i2] = sc_best ;
<a name="l00396"></a>00396       }
<a name="l00397"></a>00397     }  
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   } <span class="keywordflow">else</span> {
<a name="l00400"></a>00400     
<a name="l00401"></a>00401     <span class="comment">/* Quickshift assigns each i to the closest j which has an increase in the</span>
<a name="l00402"></a>00402 <span class="comment">     * density (E). If there is no j s.t. Ej &gt; Ei, then dists_i == inf (a root</span>
<a name="l00403"></a>00403 <span class="comment">     * node in one of the trees of merges).</span>
<a name="l00404"></a>00404 <span class="comment">     */</span>
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (i2 = 0 ; i2 &lt; N2 ; ++i2) {
<a name="l00406"></a>00406       <span class="keywordflow">for</span> (i1 = 0 ; i1 &lt; N1 ; ++i1) {
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> E0 = E [i1 + N1 * i2] ;
<a name="l00409"></a>00409         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> d_best = VL_QS_INF ;
<a name="l00410"></a>00410         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> j1_best = i1   ;
<a name="l00411"></a>00411         <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> j2_best = i2   ; 
<a name="l00412"></a>00412         
<a name="l00413"></a>00413         <span class="keywordtype">int</span> j1min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i1 - tR, 0   ) ;
<a name="l00414"></a>00414         <span class="keywordtype">int</span> j1max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i1 + tR, N1-1) ;
<a name="l00415"></a>00415         <span class="keywordtype">int</span> j2min = <a class="code" href="generic_8h.html#c8a3f4020a3e381daadd4214668dc63c" title="Max operation.">VL_MAX</a>(i2 - tR, 0   ) ;
<a name="l00416"></a>00416         <span class="keywordtype">int</span> j2max = <a class="code" href="generic_8h.html#36f2f85796040ca2f71bb34a9f55969f" title="Min operation.">VL_MIN</a>(i2 + tR, N2-1) ;      
<a name="l00417"></a>00417         
<a name="l00418"></a>00418         <span class="keywordflow">for</span> (j2 = j2min ; j2 &lt;= j2max ; ++ j2) {
<a name="l00419"></a>00419           <span class="keywordflow">for</span> (j1 = j1min ; j1 &lt;= j1max ; ++ j1) {            
<a name="l00420"></a>00420             <span class="keywordflow">if</span> (E [j1 + N1 * j2] &gt; E0) {
<a name="l00421"></a>00421               <a class="code" href="quickshift_8h.html#ee7aaa0947ccf164d8072bd798f419e2" title="quick shift datatype">vl_qs_type</a> Dij = <a class="code" href="quickshift_8c.html#5b631210954fadee8307dbe3e0c390a4" title="Computes the accumulated channel L2 distance between i,j + the distance between i...">vl_quickshift_distance</a>(I,N1,N2,K, i1,i2, j1,j2) ;
<a name="l00422"></a>00422               <span class="keywordflow">if</span> (Dij &lt;= tau2 &amp;&amp; Dij &lt; d_best) {
<a name="l00423"></a>00423                 d_best = Dij ;
<a name="l00424"></a>00424                 j1_best = j1 ;
<a name="l00425"></a>00425                 j2_best = j2 ;
<a name="l00426"></a>00426               }
<a name="l00427"></a>00427             }
<a name="l00428"></a>00428           }
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         
<a name="l00431"></a>00431         <span class="comment">/* parents is the index of the best pair */</span>
<a name="l00432"></a>00432         <span class="comment">/* dists_i is the minimal distance, inf implies no Ej &gt; Ei within</span>
<a name="l00433"></a>00433 <span class="comment">         * distance tau from the point */</span>
<a name="l00434"></a>00434         parents [i1 + N1 * i2] = j1_best + N1 * j2_best + 1 ;
<a name="l00435"></a>00435         dists[i1 + N1 * i2] = sqrt(d_best) ;
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437     }  
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439   
<a name="l00440"></a>00440   <span class="keywordflow">if</span> (M) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(M) ;
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (n) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(n) ;
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00449"></a><a class="code" href="quickshift_8h.html#57eaf395257464663a748e5e93c1b2f1">00449</a> <span class="keywordtype">void</span> <a class="code" href="quickshift_8c.html#9c2a39344fb684d899f22faf358425e8" title="Delete quick shift object.">vl_quickshift_delete</a>(<a class="code" href="struct__VlQS.html" title="quick shift results">VlQS</a> * q)
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (q) {
<a name="l00452"></a>00452     <span class="keywordflow">if</span> (q-&gt;<a class="code" href="struct__VlQS.html#78f7b05c1ee66136c396c6b706dfa6b8">parents</a>) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(q-&gt;<a class="code" href="struct__VlQS.html#78f7b05c1ee66136c396c6b706dfa6b8">parents</a>);
<a name="l00453"></a>00453     <span class="keywordflow">if</span> (q-&gt;<a class="code" href="struct__VlQS.html#216a3484bfabf0464f38bd6aed5f4af2">dists</a>)   <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(q-&gt;<a class="code" href="struct__VlQS.html#216a3484bfabf0464f38bd6aed5f4af2">dists</a>);
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (q-&gt;<a class="code" href="struct__VlQS.html#f814b044240b28c003bf69266afa1990">density</a>) <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(q-&gt;<a class="code" href="struct__VlQS.html#f814b044240b28c003bf69266afa1990">density</a>);
<a name="l00455"></a>00455     
<a name="l00456"></a>00456     <a class="code" href="generic_8h.html#bb97ff524f46d6c5ce9ca8af9e792cc3" title="Call customizable free function.">vl_free</a>(q);
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458 }
</pre></div></div>
     <!-- Doc Here -->
    </div>
   
   </div>
   <div class="clear">&nbsp;</div>
  </div> <!-- pagebody -->
  <div id="footer">
   &copy; 2005-09 Andrea Vedaldi and Brian Fulkerson
  </div> <!-- footer -->
  
  <!-- Google Analytics Begins -->
  <script xml:space="preserve" type="text/javascript">
   //<![CDATA[
    var localre = /vlfeat.org/;
    if(document.location.host.search(localre) != -1)
    {
   var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
   document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
   }
   //]]>
  </script>
  <script xml:space="preserve" type="text/javascript">
    //<![CDATA[
    var localre = /vlfeat.org/;
    if(document.location.host.search(localre) != -1)
    {

   try {
   var pageTracker = _gat._getTracker("UA-4936091-2");
   pageTracker._trackPageview();
   } catch(err) {}

   }
   //]]>
  </script>
  <!-- Google Analytics Ends -->
 </body>
</html>

 
